{% import "v4_utils.html" as v4_utils %}
{% import "utils.html" as utils %}

{% extends "layout.html" %}
{% set components = [(ts.name, v4_url_for("v4_global_status"))] %}
{% block head %}
        <link type="text/css" rel="stylesheet"
              href="{{ url_for('.static', filename='v4_global_status.css') }}"></link>
        <script async src="{{ url_for('.static', filename='popup.js') }}"></script>
        <script async src="{{ url_for('.static', filename='sorttable.js') }}"></script>
        <script language="javascript" type="text/javascript"
                src="{{ url_for('.static',
                     filename='jquery/1.7.2/jquery-1.7.2.min.js') }}"></script>
        <script language="javascript" type="text/javascript"
                src="{{ url_for('.static',
                     filename='jquery/1.7.2/jquery-ui-1.8.22.custom.min.js') }}"></script>
        <script language="javascript" type="text/javascript"
                src="{{ url_for('.static',
                     filename='jquery/jquery.scrolltofixed/jquery-scrolltofixed.min.js') }}"></script>
        <script language="javascript" type="text/javascript"
                src="{{ url_for('.static',
                     filename='jquery/jquery.contextmenu/jquery.contextMenu.min.js') }}"></script>
        <script language="javascript" type="text/javascript"
                src="{{ url_for('.static',
                     filename='jquery/jquery.formdefaults/jquery.formdefaults.min.js') }}"></script>
        <script language="javascript" type="text/javascript"
                src="{{ url_for('.static',
                     filename='v4_global_status.js') }}"></script>
        
        <style type="text/css">
          {# Generate css classes to show/hide groups and machines #}
          
          {% for m in machines %}
             table.hide-{{ m.get_css_name() }} td.{{ m.get_css_name() }},
             table.hide-{{ m.get_css_name() }} th.{{ m.get_css_name() }},
             table.hidenot-{{ m.get_css_name() }} td.not-{{ m.get_css_name() }},
             table.hidenot-{{ m.get_css_name() }} th.not-{{ m.get_css_name() }} {
                 display: none;
             }
          {% endfor %}
          {% for group in groups %}
             table.hide-{{group}} td.{{group}},
             table.hide-{{group}} th.{{group}},
             table.hidenot-{{group}} td.not-{{group}},
             table.hidenot-{{group}} th.not-{{group}} {
               display: none;
             }
          {% endfor %}
        </style>
{% endblock %}

{% block title %}Global Status - {{ selected_field.title }}{% endblock %}

{% block body %}
{# 
   This div is hidden on load and is there after controlled by the jquery
   context menu script.
#}
<div class="contextMenu" id="contextmenu-datacell">
  <ul>
    <li id="contextMenu-runpage">View Graph</li>
  </ul>
</div>

<div id="emperor-control">
  <div id="right-king-control" class="control-panel">
    <h3>Select a Comparison</h3>
    <div id="revision-control-panel">
      <form>
        <table>
          <tr>
            <td>Field:</td>
            <td>
              <select name="field" class="field-form">
                {% for f in fields %}
                  {% if f == selected_field %}
                    <option value="{{ f.name }}" selected="selected">{{ f.title }}</option>
                  {% else %}
                    <option value="{{ f.name }}">{{ f.title }}</option>
                  {% endif %}
                {% endfor %}
              </select>
            </td>
          </tr>
          <tr>
            <td>Revision:</td>
            <td><input class="baseline-form" name="revision" type="text" value="{{ selected_revision }}"/></td>
          </tr>
          <tr>
            <td><input class="baseline-form" type="submit"/></td>
          </tr>
        </table>
      </form>
    </div>    
  </div>
  
  <div id="left-king-control" class="control-panel">  
    <h3>Toggle Machine Visibility</h3>
    <div id="toggle-machine-control-panel">
      <ul>
        {% for m in machines %}
        <li><input machine="{{ m.name }}" id="checkbox-{{ m.get_css_name() }}" checked="checked" type="checkbox" onclick="v4_global_status.toggle_column_visibility('{{ m.get_css_name() }}');">{{ m.name }}</input></li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<table id="data-table" class="sortable_rev">
  <tr id="data-table-header">
    <th class="label-header">Test</th>
    <th id="worst-time-header" class="data-header worst-time">Worst Time</th>
    {% for m in machines %}
    <th class="data-header {{ m.get_css_name() }} {{ machine_groups_map[m] }}">{{ m.name }}</th>
    {% endfor %}
  </tr>
  {% for row in tests %}
  {% set outer_index = loop.index0 %}
  <tr class="data-row">
    <td class="row-head">
      {{ row[0][1] }}
    </td>
    {{ row[1]|aspctcell("data-cell worst-time")|safe }}
    {% for cr, run_id in row[2:] %}
      {{ cr.pct_delta|aspctcell("data-cell " + machines[loop.index0].get_css_name() + " " + machine_groups_map[machines[loop.index0]],
                                attributes={'test_id': row[0][0], 'run_id': run_id})
         |safe }}
    {% endfor %}
  </tr>
  {% endfor %}
</table>
{% endblock %}
