{% set db = request.get_db() %}

{% extends "layout.html" %}
{% set components = [(ts.name, v4_url_for("v4_overview"))] %}
{% block title %}Daily Report{% endblock %}
{% block body %}

<center><h2>{#
  #}(<a href="{{v4_url_for('v4_daily_report',
                          year=report.prior_days[1].year,
                          month=report.prior_days[1].month,
                          day=report.prior_days[1].day)}}">prev</a>){#
  #}<b>&nbsp;Daily Overview {{ '%04d-%02d-%02d' % (
      report.prior_days[0].year, report.prior_days[0].month,
      report.prior_days[0].day) }}&nbsp;</b>{#
  #}(<a href="{{v4_url_for('v4_daily_report',
                          year=report.next_day.year,
                          month=report.next_day.month,
                          day=report.next_day.day)}}">next</a>){#
#}</h2>
(day start is considered to be at +{{ "%02d:%02d" % (
    (report.day_start_offset.seconds // 3600),
    (report.day_start_offset.seconds // 60) % 60,)}})
</center>

{# Generate the table showing which run orders we are reporting on, for each
   machine. #}
<h3>Reported Machine Order<h3>
<table border="1">
  <thead>
    <tr>
      <th>Machine Name</th>
{% for i in range(report.num_prior_days_to_include)|reverse %}
      <th>Day - {{i}}</th>
{% endfor %}
    </tr>
  </thead>
{% for machine in report.reporting_machines %}
  <tr>
    <td>{{machine.name}}</td>
{% for i in range(report.num_prior_days_to_include)|reverse %}
{%   set order = report.prior_days_machine_order_map[i].get(machine) %}
{%   if order %}
    {# FIXME: Don't hard code field name. #}
    <td>{{order.llvm_project_revision}}</td>
{%   else %}
    <td bgcolor="#FF0000">N/A</td>
{%   endif %}
{% endfor %}
  </tr>
{% endfor %}
</table>

{% macro get_cell_value(cr) %}
{% set test_status = cr.get_test_status() %}
{% set value_status = cr.get_value_status() %}

{% if (test_status == analysis.REGRESSED or
       test_status == analysis.UNCHANGED_FAIL) %}
    <td>FAIL</td>
{% else %}

{% if (value_status == analysis.REGRESSED or
       value_status == analysis.IMPROVED) %}
    {{ cr.pct_delta|aspctcell|safe }}
{% else %}
    <td>-</td>
{% endif %}

{% endif %}
{% endmacro %}

{# Generate the table showing the raw sample data. #}
{% for field,field_results in report.result_table %}
<h3>Result Table ({{ field.name }})</h3>
<table border="1">
  <thead>
    <tr>
      <th>Test Name</th>
      <th>Machine Name</th>
{% for i in range(report.num_prior_days_to_include)|reverse %}
      <th>Day - {{i}}</th>
{% endfor %}
  </thead>
{% for test,visible_results in field_results %}
  <tr>
    <td colspan="2"><b>{{test.name}}</b></td>
    <td colspan="{{report.num_prior_days_to_include}}">&nbsp;</td>
  </tr>
{%   for machine,day_results in visible_results %}
{%   set machine_loop = loop %}
  <tr>
    <td>&nbsp;</td>
    <td>{{machine.name}}</td>
    <td>{{ day_results[-1].current }}</td>
{%     for day_result in day_results[:-1]|reverse %}
    {{ get_cell_value(day_result) }}
{%     endfor %}
  </tr>
{%   endfor %}
{% endfor %}
</table>
{% endfor %}

{% endblock %}
